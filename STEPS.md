# Analysis steps

Informations for Materials and Methods

## Data preparation

Data preparation, genotyping and filtration were done using STACKS v2.59
(https://catchenlab.life.illinois.edu/stacks/) and stacks_workflow v2.59
(https://github.com/enormandeau/stacks_workflow). Briefly, cutadapt v1.18 (-e
0.2 -m 50) was used to trim reads for quality. Samples were demultiplexed with
process_radtags v2.59 (-c -r -t 80 -q -s 0 --barcode_dist_1 2 -E phred33
--renz_1 pstI --renz_2 mspI). 

## Genotyping

### Denovo

Then we ran ustacks (-m 4 -M 3 -N 5 -H --deleverage), cstacks (-n 1), sstacks,
tsv2bam, gstacks, and population (-p 2 -r 0.6 --fasta-loci --vcf) to produce a
minimally filtered VCF file containing the genotypes of the samples.

### Reference

Then we created alignments using bwa v0.7.17-r1188 (-k 19 -c 500 -O 0,0 -E 2,2
-T 0) and samtools v1.8 (-Sb -q 1 -F 4 -F 256 -F 2048) and ran gstacks
(--max-clipped) and population (-p 2 -r 0.6 --ordered-export --fasta-loci
--vcf)

## Filtration

After these STACKS steps, we proceeded to filter the SNPs as follows. We first
filtered the SNPs (05_filter_vcf_fast.py, params: 4 70 0 3) so that all the
genotypes had a minimum coverage of 4 and kept only SNPs for which all the
sample groups had at most 30% of missing data and for which at least 3 samples
had the rare allele. This dataset was used to get the proportion of missing
data per sample. Samples with more than 15% of missing data (XXXX samples) were
excluded and removed from the original populations.snps.vcf file. This file was
filtered similarily to the first (05_filter_vcf_fast.py, params: 4 70 0 3), so
that all the genotypes had a minimum coverage of 4 and kept only SNPs for which
all the sample groups had at most 30% of missing data and for which at least 3
samples had a copy of the rare allele. Then, we evaluated relatedness for each
pair of samples and removed XXXX samples that looked too similar. We also
looked at the distribution of heterozygosity among the sample groups. XXXX
samples showed extremely low heterozygosity and were removed. We created a new
VCF file, this time excluding all the unwanted samples that either missed too
much data, were too similar to others or had high heterozygosity and proceeded
to filter this VCF again (05_filter_vcf_fast.py, params: 4 70 0 3) with the
same parameters. Using a modified HD plot approach, we then sought to remove
SNPs that seemed to display sings of paralogy or over-merging (scripts 08, 09
and 10 from stacks_workflow). Keeping only canonical SNPs, referred to as
singletons, we removed SNPs that were in high linkage disequilibrium. In these
cases, we kept only one SNP.

## Missing data imputation

Using admixture v1.3.0, the number of different samples was explored for K
values from 1 to 20. Based on the CV values returned by admixture and by
comparing the admixture graphs, a value of K=XXXX was retained and used for the
purpose of missing genotype imputation. For each SNP, missing genotypes were
generated by drawing two random alleles. The frequencies of allele 1 and 2 for
the random draw were determined by using the frequencies of the different
groups identified by admixture and the relative membership of the given sample
question to these groups. This method does not use the information of other
SNPs to predict missing genotypes and is thus is less sensitive to spurious
similarity among SNPs that have no biological link. However, it does come with
caveats of its own, which are listed in the stacks_workflow documentation.
